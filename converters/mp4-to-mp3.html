<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MP4 转 MP3 - 多功能文件转换工具</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --background: #ffffff;
            --foreground: #1a1a1a;
            --border: #e5e5e5;
            --card: #fafafa;
            --primary: #2563eb;
            --primary-foreground: #ffffff;
            --muted: #f5f5f5;
            --muted-foreground: #666666;
            --destructive: #ef4444;
            --destructive-foreground: #ffffff;
            --accent: #f0f4ff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--foreground);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            max-width: 42rem;
            margin: 0 auto;
            padding: 2rem 1.5rem;
            width: 100%;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--primary);
            color: var(--primary-foreground);
            text-decoration: none;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-family: inherit;
            transition: background 0.3s;
            margin-bottom: 2rem;
        }

        .back-button:hover {
            background: #1d4ed8;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .header-icon {
            width: 2.5rem;
            height: 2.5rem;
            color: var(--primary);
            margin-bottom: 1rem;
            display: inline-block;
        }

        h1 {
            font-size: 2.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 1rem;
            color: var(--muted-foreground);
        }

        main {
            margin-bottom: 4rem;
        }

        .dropzone {
            border: 2px dashed var(--border);
            border-radius: 0.5rem;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: var(--background);
        }

        .dropzone:hover {
            border-color: var(--primary);
            background-color: var(--accent);
        }

        .dropzone.drag-active {
            border-color: var(--primary);
            background-color: var(--accent);
        }

        .dropzone-icon {
            width: 4rem;
            height: 4rem;
            margin-bottom: 1rem;
            color: var(--muted-foreground);
        }

        .dropzone h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .dropzone p {
            font-size: 0.875rem;
            color: var(--muted-foreground);
            margin-bottom: 1.5rem;
        }

        input[type="file"] {
            display: none;
        }

        button {
            background-color: var(--primary);
            color: var(--primary-foreground);
            border: none;
            padding: 0.625rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            min-height: 2.25rem;
        }

        button:hover {
            opacity: 0.9;
        }

        button:active {
            opacity: 0.8;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button-secondary {
            background-color: transparent;
            border: 1px solid var(--border);
            color: var(--foreground);
        }

        .button-secondary:hover {
            background-color: var(--muted);
        }

        .dropzone-footer {
            margin-top: 1.5rem;
        }

        .dropzone-footer p {
            font-size: 0.75rem;
            font-family: 'Monaco', 'Menlo', monospace;
            color: var(--muted-foreground);
            margin-bottom: 0.25rem;
        }

        .card {
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .card-description {
            font-size: 0.875rem;
            color: var(--muted-foreground);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            background-color: var(--muted);
            color: var(--foreground);
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge.success {
            background-color: #dcfce7;
            color: #166534;
        }

        .badge.error {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .badge.loading {
            background-color: var(--muted);
        }

        .badge svg {
            width: 0.875rem;
            height: 0.875rem;
            margin-right: 0.25rem;
        }

        .progress-container {
            margin-bottom: 1rem;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .progress-bar {
            width: 100%;
            height: 0.5rem;
            background-color: var(--muted);
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary);
            transition: width 0.3s ease;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background-color: var(--accent);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .file-info-icon {
            width: 2rem;
            height: 2rem;
            color: var(--primary);
            flex-shrink: 0;
        }

        .file-info-text p {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .file-info-text .text-secondary {
            font-size: 0.75rem;
            color: var(--muted-foreground);
        }

        .status-message {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--muted-foreground);
            margin-bottom: 1rem;
        }

        .status-message svg {
            width: 1rem;
            height: 1rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .button-group {
            display: flex;
            gap: 0.75rem;
        }

        .button-group button {
            flex: 1;
        }

        .error-box {
            background-color: #fee2e2;
            color: #991b1b;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .hidden {
            display: none;
        }

        footer {
            border-top: 1px solid var(--border);
            padding-top: 1.5rem;
            text-align: center;
        }

        .footer-info {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            font-size: 0.875rem;
            color: var(--muted-foreground);
            margin-bottom: 1rem;
        }

        .footer-text {
            font-size: 0.75rem;
            color: var(--muted-foreground);
        }

        .spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid var(--muted);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .checking-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--muted-foreground);
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="back-button" onclick="goBack()">
            <svg style="width: 1rem; height: 1rem; margin-right: 0.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            返回主页
        </button>

        <header>
            <svg class="header-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <h1>MP4 转 MP3</h1>
            <p class="subtitle">将您的MP4视频文件转换为MP3音频文件</p>
        </header>

        <main id="main-content">
            <!-- 上传区域 -->
            <div id="dropzone-section">
                <div class="dropzone" id="dropzone">
                    <svg class="dropzone-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <h2>拖放文件到这里</h2>
                    <p>或者点击选择文件</p>
                    <input type="file" id="file-input" accept="video/mp4,.mp4">
                    <button onclick="document.getElementById('file-input').click()">选择MP4文件</button>
                    <div class="dropzone-footer">
                        <p>仅支持MP4格式</p>
                        <p>最大文件大小: 100MB</p>
                    </div>
                </div>
            </div>

            <!-- 处理中 -->
            <div id="processing-section" class="hidden">
                <div class="card">
                    <div class="card-header">
                        <div style="flex: 1;">
                            <div class="card-title" id="filename-display"></div>
                            <div class="card-description" id="filesize-display"></div>
                        </div>
                        <div class="badge loading">
                            <div class="spinner"></div>
                            <span id="status-text">转换中...</span>
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span id="progress-label">转换进度</span>
                            <span class="monospace" id="progress-value">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div class="status-message">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 2m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span id="status-message-text">正在转换文件，请稍候...</span>
                    </div>
                    <div class="checking-status" id="checking-status">
                        <div class="spinner" style="width: 0.875rem; height: 0.875rem;"></div>
                        <span>检查转换状态...</span>
                    </div>
                </div>
            </div>

            <!-- 完成 -->
            <div id="completed-section" class="hidden">
                <div class="card">
                    <div class="card-header">
                        <div style="flex: 1;">
                            <div class="card-title" id="completed-filename-display"></div>
                            <div class="card-description" id="completed-filesize-display"></div>
                        </div>
                        <div class="badge success">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span>转换完成</span>
                        </div>
                    </div>
                    <div class="file-info">
                        <svg class="file-info-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6a2 2 0 012-2h6a2 2 0 012 2v12a2 2 0 01-2 2H11a2 2 0 01-2-2z"></path>
                        </svg>
                        <div class="file-info-text">
                            <p id="output-filename"></p>
                            <div class="text-secondary">MP3音频文件</div>
                        </div>
                    </div>
                    <div class="button-group">
                        <button onclick="downloadFile()" id="download-btn">
                            <svg style="width: 1rem; height: 1rem; margin-right: 0.5rem; vertical-align: middle;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            下载MP3
                        </button>
                        <button class="button-secondary" onclick="resetForm()">转换另一个</button>
                    </div>
                </div>
            </div>

            <!-- 错误 -->
            <div id="error-section" class="hidden">
                <div class="card" style="border-color: var(--destructive);">
                    <div class="card-header">
                        <div style="flex: 1;">
                            <div class="card-title" id="error-filename-display"></div>
                            <div class="card-description" id="error-filesize-display"></div>
                        </div>
                        <div class="badge error">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l-2-2m0 0l-2 2m2-2l2 2m-2-2l-2-2"></path>
                            </svg>
                            <span>转换失败</span>
                        </div>
                    </div>
                    <div class="error-box" id="error-message"></div>
                    <button onclick="resetForm()" style="width: 100%;" class="button-secondary">重试</button>
                </div>
            </div>
        </main>

        <footer>
            <div class="footer-info">
                <span>支持格式: MP4</span>
                <span>输出格式: MP3</span>
            </div>
            <p class="footer-text">文件在转换后会自动清理，确保您的隐私安全</p>
        </footer>
    </div>

    <script>
        // 使用你的实际后端地址
        const API_URL = 'https://multi-tool-web-backend.onrender.com';
        let currentTaskId = null;
        let isProcessing = false;
        let statusCheckInterval = null;

        function goBack() {
            window.location.href = '/';
        }

        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('file-input');

        // 拖拽事件
        dropzone.addEventListener('dragenter', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropzone.classList.add('drag-active');
        });

        dropzone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropzone.classList.remove('drag-active');
        });

        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
        });

        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropzone.classList.remove('drag-active');
            if (e.dataTransfer.files[0]) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        // 文件选择
        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) {
                handleFile(e.target.files[0]);
            }
        });

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function showSection(sectionId) {
            document.getElementById('dropzone-section').classList.add('hidden');
            document.getElementById('processing-section').classList.add('hidden');
            document.getElementById('completed-section').classList.add('hidden');
            document.getElementById('error-section').classList.add('hidden');
            
            if (sectionId) {
                document.getElementById(sectionId).classList.remove('hidden');
            }
        }

        function handleFile(file) {
            if (isProcessing) return;

            const maxSize = 100 * 1024 * 1024;
            
            if (!file.type.includes('video/mp4') && !file.name.toLowerCase().endsWith('.mp4')) {
                alert('请上传MP4格式的视频文件');
                return;
            }

            if (file.size > maxSize) {
                alert('文件大小不能超过100MB');
                return;
            }

            uploadAndConvert(file);
        }

        function uploadAndConvert(file) {
            isProcessing = true;
            currentTaskId = null;
            
            document.getElementById('filename-display').textContent = file.name;
            document.getElementById('filesize-display').textContent = formatFileSize(file.size);
            document.getElementById('progress-label').textContent = '转换进度';
            document.getElementById('status-text').textContent = '转换中...';
            document.getElementById('status-message-text').textContent = '正在转换文件，请稍候...';
            
            showSection('processing-section');

            const formData = new FormData();
            formData.append('file', file);

            // 模拟进度
            simulateProgress();

            // 发送请求到后端
            fetch(`${API_URL}/api/convert/mp4-to-mp3`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    currentTaskId = data.task_id;
                    // 开始检查转换状态
                    startStatusChecking();
                } else {
                    showError(data.error || '转换失败');
                }
            })
            .catch(error => {
                showError('网络错误，请检查您的连接: ' + error.message);
            });
        }

        function startStatusChecking() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            
            statusCheckInterval = setInterval(() => {
                if (!currentTaskId) return;
                
                fetch(`${API_URL}/api/task/${currentTaskId}`)
                    .then(response => response.json())
                    .then(task => {
                        if (task.status === 'completed') {
                            clearInterval(statusCheckInterval);
                            // 显示成功结果
                            document.getElementById('completed-filename-display').textContent = document.getElementById('filename-display').textContent;
                            document.getElementById('completed-filesize-display').textContent = document.getElementById('filesize-display').textContent;
                            document.getElementById('output-filename').textContent = task.output_filename;
                            
                            updateProgress(100);
                            setTimeout(() => {
                                showSection('completed-section');
                                isProcessing = false;
                            }, 500);
                            
                        } else if (task.status === 'error') {
                            clearInterval(statusCheckInterval);
                            showError(task.error || '转换失败');
                        }
                        // 如果还是 processing 状态，继续等待
                    })
                    .catch(error => {
                        console.error('检查状态失败:', error);
                    });
            }, 2000); // 每2秒检查一次
        }

        function simulateProgress() {
            let progress = 0;
            const interval = setInterval(() => {
                progress += 2;
                if (progress >= 90) {
                    clearInterval(interval);
                }
                updateProgress(progress);
            }, 500);
        }

        function updateProgress(progress) {
            document.getElementById('progress-fill').style.width = progress + '%';
            document.getElementById('progress-value').textContent = progress + '%';
        }

        function showError(message) {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            
            document.getElementById('error-filename-display').textContent = document.getElementById('filename-display').textContent;
            document.getElementById('error-filesize-display').textContent = document.getElementById('filesize-display').textContent;
            document.getElementById('error-message').textContent = message;
            showSection('error-section');
            isProcessing = false;
        }

        function downloadFile() {
            if (!currentTaskId) {
                alert('请先完成文件转换');
                return;
            }
            
            // 显示加载状态
            const downloadBtn = document.getElementById('download-btn');
            const originalText = downloadBtn.innerHTML;
            downloadBtn.innerHTML = '<div class="spinner" style="width: 1rem; height: 1rem; margin-right: 0.5rem;"></div>下载中...';
            downloadBtn.disabled = true;
            
            // 真实下载
            const a = document.createElement('a');
            a.href = `${API_URL}/api/download/${currentTaskId}`;
            a.download = document.getElementById('output-filename').textContent;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            // 恢复按钮状态
            setTimeout(() => {
                downloadBtn.innerHTML = originalText;
                downloadBtn.disabled = false;
            }, 2000);
        }

        function resetForm() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            isProcessing = false;
            currentTaskId = null;
            document.getElementById('progress-fill').style.width = '0%';
            document.getElementById('progress-value').textContent = '0%';
            fileInput.value = '';
            showSection('dropzone-section');
        }
    </script>
</body>
</html>
